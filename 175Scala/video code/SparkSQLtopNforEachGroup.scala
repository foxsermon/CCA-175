Top n records from each group - Spark SQL solution

product_id int(11) NOT NULL AUTO_INCREMENT, 
product_category_id int(11) NOT NULL,
product_name varchar(45) NOT NULL,  
product_description varchar(255) NOT NULL, 
product_price float NOT NULL,
product_image varchar(255) NOT NULL

val productsRDD = sc.textFile("products").filter(x=>x.split(",")(4)!="")

val productsRDDmap = productsRDD.map(a => (a.split(",")(0).toInt, a.split(",")(1).toInt, a.split(",")(2), a.split(",")(4).toFloat))
val productsRDDmapDF = productsRDDmap.toDF("product_id","product_category_id", "product_name", "product_price")
+----------+-------------------+---------------------------------------------+-------------+
|product_id|product_category_id|product_name                                 |product_price|
+----------+-------------------+---------------------------------------------+-------------+
|1         |2                  |Quest Q64 10 FT. x 10 FT. Slant Leg Instant U|59.98        |
|2         |2                  |Under Armour Men's Highlight MC Football Clea|129.99       |
|3         |2                  |Under Armour Men's Renegade D Mid Football Cl|89.99        |
+----------+-------------------+---------------------------------------------+-------------+
only showing top 3 rows

productsRDDmapDF.registerTempTable("products")

val query = """
select product_id, product_category_id, product_price
from 
(
   select product_id, product_category_id, product_price,
      (@num:=if(@group = product_category_id, @num +1, if(@group := product_category_id, 1, 1))) row_number 
  from products t
  CROSS JOIN (select @num:=0, @group:=null) c
  order by product_category_id, product_price desc, product_id
) as x 
where x.row_number <= 3
"""

val result = sqlContext.sql(query)

scala> sqlContext.sql("select  product_id ,  row_number() over(partition by product_category_id  order by product_price  desc) as  p_order ,product_price  , product_category_id from   products  ").select("product_id","product_category_id","product_price","p_order").where("p_order<=3").show(200)

+----------+-------------------+-------------+-------+
|product_id|product_category_id|product_price|p_order|
+----------+-------------------+-------------+-------+
|       676|                 31|        899.0|      1|
|       675|                 31|        799.0|      2|
|       689|                 31|       599.99|      3|
|       694|                 32|       999.99|      1|
|       695|                 32|       999.99|      2|
|       698|                 32|       699.99|      3|
|       739|                 33|       169.99|      1|
|       740|                 33|       169.99|      2|
|       718|                 33|       139.99|      3|
|       743|                 34|       169.99|      1|
|       744|                 34|       169.99|      2|
|       745|                 34|       149.99|      3|
|       766|                 35|       299.99|      1|
|       768|                 35|       299.99|      2|
|       773|                 35|       249.99|      3|
|       791|                 36|        24.99|      1|
|       794|                 36|        24.99|      2|
|       806|                 36|        24.99|      3|
|       817|                 37|        51.99|      1|
|       819|                 37|        51.99|      2|
|       821|                 37|        51.99|      3|
|       860|                 38|       599.99|      1|
|       300|                 38|       449.99|      2|
|       307|                 38|       449.99|      3|
|       861|                 39|       199.99|      1|
|       862|                 39|       179.99|      2|
|       880|                 39|       139.99|      3|
|       885|                 40|        24.99|      1|
|       886|                 40|        24.99|      2|
|       887|                 40|        24.99|      3|
|       601|                 41|       399.99|      1|
|       606|                 41|       299.99|      2|
|       607|                 41|       249.99|      3|
|       933|                 42|       179.99|      1|
|       935|                 42|       169.99|      2|
|       937|                 42|       169.99|      3|
|       953|                 43|       449.99|      1|
|       944|                 43|       399.99|      2|
|       955|                 43|       399.99|      3|
|       978|                 44|       399.99|      1|
|       983|                 44|       249.99|      2|
|       966|                 44|       199.99|      3|
|      1009|                 45|       599.99|      1|
|       987|                 45|       399.99|      2|
|       995|                 45|       399.99|      3|
|      1016|                 46|       549.99|      1|
|      1020|                 46|       549.99|      2|
|      1011|                 46|       499.99|      3|
|      1048|                 47|      1099.99|      1|
|      1054|                 47|       699.99|      2|
|      1035|                 47|       499.99|      3|
|      1069|                 48|       799.99|      1|
|      1067|                 48|       549.99|      2|
|      1074|                 48|       549.99|      3|
|      1084|                 49|       399.99|      1|
|      1104|                 49|       399.99|      2|
|      1085|                 49|       349.99|      3|
|      1116|                 50|        130.0|      1|
|      1117|                 50|        130.0|      2|
|      1118|                 50|        130.0|      3|
|      1136|                 51|       219.99|      1|
|      1138|                 51|       219.99|      2|
|      1139|                 51|       219.99|      3|
|      1154|                 52|        170.0|      1|
|      1156|                 52|        170.0|      2|
|      1157|                 52|        170.0|      3|
|      1182|                 53|       199.99|      1|
|      1192|                 53|       199.99|      2|
|      1193|                 53|       199.99|      3|
|      1214|                 54|       299.99|      1|
|      1216|                 54|       299.99|      2|
|      1210|                 54|       199.99|      3|
|      1226|                 55|         85.0|      1|
|      1227|                 55|         85.0|      2|
|      1235|                 55|         85.0|      3|
|      1256|                 56|       159.99|      1|
|      1259|                 56|       159.99|      2|
|      1250|                 56|         90.0|      3|
|      1279|                 57|       189.99|      1|
|      1297|                 57|       174.99|      2|
|      1281|                 57|       159.99|      3|
|      1319|                 58|        241.0|      1|
|      1299|                 58|        194.0|      2|
|      1302|                 58|        130.0|      3|
|      1323|                 59|        100.0|      1|
|      1330|                 59|        100.0|      2|
|      1331|                 59|        100.0|      3|
|        16|                  2|       299.99|      1|
|        11|                  2|       209.99|      2|
|         5|                  2|       199.99|      3|
|        40|                  3|       199.99|      1|
|        32|                  3|       189.99|      2|
|        35|                  3|       159.99|      3|
|        66|                  4|      1799.99|      1|
|        60|                  4|       999.99|      2|
|        71|                  4|       349.98|      3|
|        74|                  5|       499.99|      1|
|        96|                  5|       299.99|      2|
|        79|                  5|       209.99|      3|
|       117|                  6|       399.99|      1|
|       106|                  6|       299.99|      2|
|       100|                  6|       199.99|      3|
|       127|                  7|       329.99|      1|
|       137|                  7|       299.99|      2|
|       144|                  7|       249.99|      3|
|       162|                  8|       399.99|      1|
|       153|                  8|       299.99|      2|
|       148|                  8|       199.99|      3|
|       185|                  9|       499.99|      1|
|       181|                  9|       399.99|      2|
|       169|                  9|       299.98|      3|
|       208|                 10|      1999.99|      1|
|       199|                 10|      1799.99|      2|
|       197|                 10|       999.99|      3|
|       229|                 11|       799.99|      1|
|       226|                 11|       599.99|      2|
|       225|                 11|       499.99|      3|
|       262|                 12|       179.99|      1|
|       255|                 12|       139.99|      2|
|       260|                 12|       119.99|      3|
|       268|                 13|       199.99|      1|
|       281|                 13|        99.99|      2|
|       265|                 13|        79.99|      3|
|       320|                 15|        100.0|      1|
|       322|                 15|        81.99|      2|
|       325|                 15|         79.0|      3|
|       346|                 16|       349.99|      1|
|       343|                 16|       299.99|      2|
|       345|                 16|       249.99|      3|
|       371|                 17|       399.99|      1|
|       364|                 17|       299.99|      2|
|       366|                 17|       299.99|      3|
|       382|                 18|       189.99|      1|
|       390|                 18|       139.99|      2|
|       399|                 18|       139.99|      3|
|       407|                 19|       189.99|      1|
|       425|                 19|       149.99|      2|
|       417|                 19|       139.99|      3|
|       450|                 20|       249.99|      1|
|       452|                 20|       169.99|      2|
|       437|                 20|       139.99|      3|
|       458|                 21|       139.99|      1|
|       453|                 21|        99.99|      2|
|       463|                 21|        99.99|      3|
|       496|                 22|      1799.99|      1|
|       488|                 22|       999.99|      2|
|       481|                 22|       179.98|      3|
|       516|                 24|       229.99|      1|
|       508|                 24|       189.99|      2|
|       513|                 24|       159.99|      3|
|       545|                 25|       229.99|      1|
|       534|                 25|       189.99|      2|
|       536|                 25|       179.98|      3|
|       566|                 26|         90.0|      1|
|       569|                 26|         90.0|      2|
|       560|                 26|         85.0|      3|
|       590|                 27|         90.0|      1|
|       593|                 27|         90.0|      2|
|       584|                 27|         85.0|      3|
|       625|                 29|       199.99|      1|
|       629|                 29|       169.99|      2|
|       623|                 29|       149.99|      3|
|       663|                 30|       139.99|      1|
|       664|                 30|       139.99|      2|
|       665|                 30|       139.99|      3|


